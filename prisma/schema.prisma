generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            Int            @id @default(autoincrement())
  email         String         @unique
  name          String?
  password      String         // Bcrypt-hashed password
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  // Auth Flags
  firstLogin          Boolean        @default(true)
  forcePasswordChange Boolean        @default(true)
  isActive            Boolean        @default(true)
  
  // Relations
  posts         Post[]
  refreshTokens RefreshToken[]
  auditLogs     AuditLog[]
  
  // RBAC & Organization
  departmentId  Int?
  department    Department?    @relation(fields: [departmentId], references: [id])
  userRoles     UserRole[]
  userWarehouses UserWarehouse[]
}

model Department {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  users       User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Role {
  id          Int              @id @default(autoincrement())
  name        String           @unique // e.g., "SUPER_ADMIN", "HR_MANAGER"
  description String?
  userRoles   UserRole[]
  permissions RolePermission[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model Permission {
  id          Int              @id @default(autoincrement())
  action      String           // e.g., "create", "read", "update", "delete"
  resource    String           // e.g., "users", "reports", "inventory"
  description String?
  roles       RolePermission[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@unique([action, resource]) // Prevent duplicate permissions
}

model RolePermission {
  roleId       Int
  permissionId Int
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  assignedAt   DateTime   @default(now())

  @@id([roleId, permissionId])
}

model UserRole {
  userId     Int
  roleId     Int
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  assignedAt DateTime @default(now())

  @@id([userId, roleId])
}

model Post {
  id        Int     @id @default(autoincrement())
  title     String
  content   String?
  published Boolean @default(false)
  authorId  Int
  author    User    @relation(fields: [authorId], references: [id])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  isRevoked Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  action      String   // e.g. "CREATE", "UPDATE", "DELETE"
  module      String   // e.g. "ROLES", "USERS"
  resourceId  String?  // ID of the affected resource
  before      Json?    // State before action
  after       Json?    // State after action
  metadata    Json?    // IP, User Agent, etc.
  timestamp   DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([timestamp])
}

model Warehouse {
  id          Int             @id @default(autoincrement())
  name        String          @unique
  location    String?
  status      String          @default("ACTIVE") // ACTIVE, INACTIVE
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  userWarehouses UserWarehouse[]
}

model UserWarehouse {
  userId      Int
  warehouseId Int
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  assignedAt  DateTime  @default(now())

  @@id([userId, warehouseId])
}
model Unit {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  symbol    String   @unique
  unitType  String   // e.g., "WEIGHT", "LENGTH", "COUNT"
  isBase    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  conversionsFrom UnitConversion[] @relation("FromUnit")
  conversionsTo   UnitConversion[] @relation("ToUnit")
}

model UnitConversion {
  id             Int      @id @default(autoincrement())
  fromUnitId     Int
  toUnitId       Int
  conversionRate Float
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  fromUnit Unit @relation("FromUnit", fields: [fromUnitId], references: [id], onDelete: Restrict)
  toUnit   Unit @relation("ToUnit", fields: [toUnitId], references: [id], onDelete: Restrict)

  @@unique([fromUnitId, toUnitId])
}

// --- Global Settings Models ---

model Company {
  id         Int      @id @default(autoincrement())
  legalName  String
  tradeName  String?
  address    String?
  country    String?
  phone      String?
  email      String?
  taxId      String?
  logoUrl    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model FiscalYear {
  id        Int      @id @default(autoincrement())
  name      String   @unique // e.g., "FY 2024-25"
  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(false)
  isLocked  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Currency {
  id            Int      @id @default(autoincrement())
  code          String   @unique // e.g., "USD", "PKR"
  symbol        String   // e.g., "$", "Rs"
  isBase        Boolean  @default(false)
  exchangeRate  Float    @default(1.0) // Rate relative to Base Currency
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model SystemConfig {
  id                Int      @id @default(autoincrement())
  quantityDecimals  Int      @default(2)
  amountDecimals    Int      @default(2)
  rateDecimals      Int      @default(4)
  updatedAt         DateTime @updatedAt
}

model SystemSetting {
  key         String   @id // e.g., "allow_negative_inventory"
  value       String   // e.g., "true" or "false"
  description String?
  updatedAt   DateTime @updatedAt
}
