generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            Int            @id @default(autoincrement())
  email         String         @unique
  name          String?
  password      String         // Bcrypt-hashed password
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  // Auth Flags
  firstLogin          Boolean        @default(true)
  forcePasswordChange Boolean        @default(true)
  isActive            Boolean        @default(true)
  
  // Relations
  posts         Post[]
  refreshTokens RefreshToken[]
  auditLogs     AuditLog[]
  
  // RBAC & Organization
  departmentId  Int?
  department    Department?    @relation(fields: [departmentId], references: [id])
  userRoles     UserRole[]
}

model Department {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  users       User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Role {
  id          Int              @id @default(autoincrement())
  name        String           @unique // e.g., "SUPER_ADMIN", "HR_MANAGER"
  description String?
  userRoles   UserRole[]
  permissions RolePermission[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model Permission {
  id          Int              @id @default(autoincrement())
  action      String           // e.g., "create", "read", "update", "delete"
  resource    String           // e.g., "users", "reports", "inventory"
  description String?
  roles       RolePermission[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@unique([action, resource]) // Prevent duplicate permissions
}

model RolePermission {
  roleId       Int
  permissionId Int
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  assignedAt   DateTime   @default(now())

  @@id([roleId, permissionId])
}

model UserRole {
  userId     Int
  roleId     Int
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  assignedAt DateTime @default(now())

  @@id([userId, roleId])
}

model Post {
  id        Int     @id @default(autoincrement())
  title     String
  content   String?
  published Boolean @default(false)
  authorId  Int
  author    User    @relation(fields: [authorId], references: [id])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  isRevoked Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  action      String   // e.g. "CREATE", "UPDATE", "DELETE"
  module      String   // e.g. "ROLES", "USERS"
  resourceId  String?  // ID of the affected resource
  before      Json?    // State before action
  after       Json?    // State after action
  metadata    Json?    // IP, User Agent, etc.
  timestamp   DateTime @default(now())

  @@index([userId])
  @@index([module])
  @@index([action])
  @@index([timestamp])
}